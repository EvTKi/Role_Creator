name: üèóÔ∏è –°–±–æ—Ä–∫–∞ .exe –∏ —Ä–µ–ª–∏–∑

on:
  push:
    tags:
      - 'v*'

jobs:
  build-exe:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ['3.11']

    steps:
      - name: üîπ Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4

      - name: üîπ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: üîπ –ß—Ç–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ VERSION
        id: version
        run: |
          $version = Get-Content -Path VERSION -Encoding UTF8 | ForEach-Object { $_.Trim() }
          echo "RELEASE_VERSION=$version" >> $env:GITHUB_ENV
          echo "TAG_NAME=v$version" >> $env:GITHUB_ENV
        shell: pwsh

      - name: üîπ –ò–∑–≤–ª–µ—á—å –∑–∞–º–µ—Ç–∫–∏ –∏–∑ CHANGELOG.md
        id: changelog
        run: |
          $version = "${{ env.RELEASE_VERSION }}"
          if (Test-Path CHANGELOG.md) {
            $content = Get-Content -Path CHANGELOG.md -Raw -Encoding UTF8
            $pattern = "(?s)(?<=^## \[$version\][^\n]*\n)(.*?)(?=\n## |\Z)"
            $match = [regex]::Match($content, $pattern, "Multiline")
            if ($match.Success) {
              $notes = $match.Value.Trim()
            } else {
              $notes = "–ó–∞–º–µ—Ç–∫–∏ –¥–ª—è –≤–µ—Ä—Å–∏–∏ $version –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
            }
          } else {
            $notes = "CHANGELOG.md –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã."
          }
          $notes = $notes -replace '"', '\"' -replace '\$', '$$'
          echo "RELEASE_NOTES<<EOF" >> $env:GITHUB_ENV
          echo "$notes" >> $env:GITHUB_ENV
          echo "EOF" >> $env:GITHUB_ENV
        shell: pwsh

      - name: üîπ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          pip install pyinstaller toml PyQt5 lxml chardet

      - name: üîπ –°–±–æ—Ä–∫–∞ —á–µ—Ä–µ–∑ build.py
        run: |
          python build-tools/build.py
        shell: pwsh

      - name: üîπ –°–æ–∑–¥–∞—Ç—å —Ä–µ–ª–∏–∑
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: –í—ã–ø—É—Å–∫ ${{ env.TAG_NAME }}
          body: |
            ### üì¶ –ß—Ç–æ –Ω–æ–≤–æ–≥–æ

            ${{ env.RELEASE_NOTES }}

            ### üì¶ –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ

            - `–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä CSV-RDF.exe` ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
            - `config.json` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

            –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ `.exe`.

            –í–µ—Ä—Å–∏—è: ${{ env.RELEASE_VERSION }}
          draft: false
          prerelease: false
          files: dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}